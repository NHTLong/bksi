services:
    zookeeper:
        image: confluentinc/cp-zookeeper:latest
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_SERVER_ID: 1
        ports:
            - '2181:2181'
        networks:
            - app-network

    kafka-1:
        image: confluentinc/cp-kafka:latest
        ports:
            - '9092:9092'
            - '29092:29092'
        environment:
            KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka-1:19092,EXTERNAL://${DOCKER_HOST_IP:-127.0.0.1}:9092,DOCKER://host.docker.internal:29092
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,DOCKER:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
            KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
            KAFKA_BROKER_ID: 1
        depends_on:
            - zookeeper
        networks:
            - app-network

    kafka-2:
        image: confluentinc/cp-kafka:latest
        ports:
            - '9093:9093'
            - '29093:29093'
        environment:
            KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka-2:19093,EXTERNAL://${DOCKER_HOST_IP:-127.0.0.1}:9093,DOCKER://host.docker.internal:29093
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,DOCKER:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
            KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
            KAFKA_BROKER_ID: 2
        depends_on:
            - zookeeper
        networks:
            - app-network

    kafka-3:
        image: confluentinc/cp-kafka:latest
        ports:
            - '9094:9094'
            - '29094:29094'
        environment:
            KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka-3:19094,EXTERNAL://${DOCKER_HOST_IP:-127.0.0.1}:9094,DOCKER://host.docker.internal:29094
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,DOCKER:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
            KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
            KAFKA_BROKER_ID: 3
        depends_on:
            - zookeeper
        networks:
            - app-network

    kafdrop1:
        image: obsidiandynamics/kafdrop
        ports:
            - '9000:9000'
        environment:
            KAFKA_BROKERCONNECT: kafka-1:19092,kafka-2:19093,kafka-3:19094
            JVM_OPTS: '-Xms32M -Xmx64M'
        networks:
            - app-network

    redis:
        image: redis
        container_name: redis-server
        ports:
            - '6379:6379'
        volumes:
            - redis-data:/data
        networks:
            - app-network

    mongodb:
        image: mongo:latest
        container_name: mongodb
        restart: always
        ports:
            - '27017:27017'
        environment:
            MONGO_INITDB_ROOT_USERNAME: admin
            MONGO_INITDB_ROOT_PASSWORD: password
        volumes:
            - mongodb-data:/data/db
        networks:
            - app-network
    prometheus:
        image: prom/prometheus:latest
        container_name: prometheus
        ports:
            - '9090:9090'
        volumes:
            - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
            - prom-config:/etc/prometheus/targets
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--web.enable-lifecycle'
        networks:
            - app-network
    dashboard:
        build:
            context: .
            dockerfile: dashboard/Dockerfile
        container_name: dashboard
        ports:
            - '8080:8080'
        volumes:
            - prom-config:/etc/prometheus/targets
        user: root
        env_file:
            - ./dashboard/.env
        depends_on:
            - prometheus
        networks:
            - app-network

    grafana:
        image: grafana/grafana:latest
        container_name: grafana
        ports:
            - '3000:3000'
        environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=admin
        volumes:
            - grafana_data:/var/lib/grafana
        depends_on:
            - prometheus
        networks:
            - app-network
    connect:
        image: debezium/connect:latest
        container_name: connect
        ports:
            - '8083:8083'
        environment:
            GROUP_ID: 1
            BOOTSTRAP_SERVERS: kafka-1:19092,kafka-2:19093,kafka-3:19094
            CONFIG_STORAGE_TOPIC: connect_configs
            OFFSET_STORAGE_TOPIC: connect_offsets
            STATUS_STORAGE_TOPIC: connect_statuses
            CONNECT_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
            CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
            CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE: 'false'
            CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: 'false'
            # Auto create connector
            CONNECT_CONNECTOR_CONFIGURATION: |
                {
                    "name": "mysql-connector",
                    "config": {
                        "connector.class": "io.debezium.connector.mysql.MySqlConnector",
                        "database.hostname": "mysql",
                        "database.port": "3306",
                        "database.user": "mysqluser",
                        "database.password": "mysqlpw",
                        "database.server.id": "1",
                        "database.server.name": "dbserver1",
                        "database.include.list": "inventory",
                        "table.include.list": "inventory.customers",
                        "database.history.kafka.bootstrap.servers": "kafka-1:19092,kafka-2:19093,kafka-3:19094",
                        "database.history.kafka.topic": "schema-changes.inventory",
                        "include.schema.changes": "true"
                    }
                }
        depends_on:
            - kafka-1
            - kafka-2
            - kafka-3
            - mysql
        networks:
            - app-network
networks:
    app-network:
        driver: bridge

volumes:
    redis-data:
    mongodb-data:
        driver: local
    prometheus_data:
        driver: local
    grafana_data:
    prom-config:
        driver: local
